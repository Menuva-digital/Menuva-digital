<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Menuva Book — Dine‑In (Luxury)</title>
  <style>
    /* =====================
       THEME (Light / Dark)
       ===================== */
    :root {
      --bg: #f4f8ff;
      --surface: #ffffff;
      --text: #1f2a44;
      --muted: #6b7a99;
      --border: #d8e1ff;
      --brand: #1f70ff;
      --brand-2: #2a5298;
      --brand-3: #1e3c72;
      --chip: #eef4ff;
      --danger: #e54646;
      --success: #25d366;
      --shadow: 0 6px 24px rgba(0,0,0,.08);
    }
    body.dark {
      --bg: #0e1116;
      --surface: #141922;
      --text: #e6ebff;
      --muted: #aab6db;
      --border: #263148;
      --brand: #4da3ff;
      --chip: #0f1a2a;
      --shadow: 0 8px 28px rgba(0,0,0,.5);
    }

    /* =====================
       BASE
       ===================== */
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg); color: var(--text); transition: background .3s, color .3s;
    }
    img { max-width: 100%; display: block; }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 16px; }

    /* =====================
       HEADER
       ===================== */
    header {
      background: linear-gradient(90deg, var(--brand-2), var(--brand-3));
      color: #fff; padding: 22px 0 18px; position: sticky; top: 0; z-index: 50; box-shadow: var(--shadow);
    }
    .header-inner { display: grid; grid-template-columns: 80px 1fr 48px; gap: 12px; align-items: center; }
    #restoLogo { height: 64px; width: 64px; object-fit: contain; border-radius: 12px; background: rgba(255,255,255,.1); }
    #restoName { margin: 0; font-size: 26px; letter-spacing: .2px; }
    .contact-info { font-size: 12px; opacity: .9; }
    .dark-toggle {
      width: 44px; height: 44px; border-radius: 50%; border: 1px solid rgba(255,255,255,.35);
      background: transparent; color: #fff; cursor: pointer; font-size: 18px;
    }

    /* =====================
       TABS
       ===================== */
    .tabs-wrap { background: var(--surface); position: sticky; top: 104px; z-index: 40; box-shadow: var(--shadow); }
    .tabs { display: flex; gap: 8px; padding: 10px; justify-content: center; flex-wrap: wrap; }
    .tab { padding: 8px 14px; border: 1px solid var(--border); border-radius: 999px; background: var(--chip); color: var(--text); cursor: pointer; font-weight: 600; }
    .tab.active { background: var(--brand); color: #fff; border-color: var(--brand); }

    /* =====================
       GRID CONTENT
       ===================== */
    .tab-content { display: none; padding: 20px 0; }
    .tab-content.active { display: block; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }

    .menu-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 6px; box-shadow: var(--shadow);
      padding: 12px; display: flex; flex-direction: column; gap: 8px; cursor: pointer; transition: transform .18s ease, box-shadow .18s ease;
    }
    .menu-card:hover { transform: translateY(-2px); }
    .menu-thumb { height: 140px; border-radius: 12px; object-fit: cover; background: #e9eefc; }
    .menu-title { font-weight: 800; font-size: 16px; letter-spacing: .2px; }
    .menu-desc { font-size: 13px; color: var(--muted); min-height: 32px; }
    .menu-price { margin-top: 4px; font-weight: 800; color: var(--brand); }

    /* =====================
       PROMO CARD
       ===================== */
    .promo-card { position: relative; overflow: hidden; }
    .promo-badge { position: absolute; top: 10px; left: 10px; background: #ffcc00; color: #222; font-weight: 800; font-size: 12px; padding: 4px 8px; border-radius: 999px; }
    .promo-count { font-size: 12px; color: #e33; font-weight: 700; }

    /* =====================
       CART
       ===================== */
    footer { background: var(--surface); margin-top: 24px; box-shadow: var(--shadow); }
    .footer-inner { padding: 18px 0 24px; }

    .cart { border: 1px solid var(--border); border-radius: 16px; padding: 12px; background: var(--surface); }
    .cart h3 { margin: 6px 6px 10px; font-size: 18px; }
    .cart-empty { color: var(--muted); padding: 8px; }

    .cart-row { display: grid; grid-template-columns: 1fr 76px 92px 28px; gap: 8px; align-items: center; padding: 6px 8px; border-bottom: 1px dashed var(--border); }
    .cart-row:last-child { border-bottom: none; }
    .qty-wrap { display: inline-flex; border: 1px solid var(--border); border-radius: 999px; overflow: hidden; }
    .qty-wrap button { width: 28px; height: 28px; border: 0; background: var(--chip); cursor: pointer; font-weight: 800; }
    .qty-wrap input { width: 36px; text-align: center; border: 0; background: transparent; color: var(--text); font-weight: 700; }
    .price-right { text-align: right; font-weight: 700; }
    .remove-btn { border: 0; background: transparent; color: var(--danger); font-size: 18px; cursor: pointer; }

    .cart-total { padding: 10px 8px 0; display: flex; justify-content: space-between; font-weight: 800; }

    /* =====================
       FORM
       ===================== */
    .form { margin-top: 18px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .form label { display: block; font-weight: 700; font-size: 13px; margin-bottom: 4px; color: var(--muted); }
    .form input, .form textarea { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--surface); color: var(--text); }
    .form textarea { grid-column: 1 / -1; min-height: 80px; resize: vertical; }

    .actions { display: flex; gap: 10px; margin-top: 12px; }
    .btn { flex: 1; padding: 12px; border-radius: 12px; border: 0; cursor: pointer; font-weight: 800; }
    .btn-wa { background: var(--success); color: #fff; }
    .btn-back { background: #f39c12; color: #fff; }

    /* =====================
       RESPONSIVE
       ===================== */
    @media (max-width: 640px) {
      .header-inner { grid-template-columns: 56px 1fr 44px; }
      #restoLogo { height: 48px; width: 48px; }
      .tabs-wrap { top: 88px; }
      .form { grid-template-columns: 1fr; }
      .cart-row { grid-template-columns: 1fr 84px 84px 28px; }
    }
    .order-count {
  position: absolute;
  top: 8px;
  right: 8px;
  background: var(--brand);
  color: #fff;
  font-size: 12px;
  font-weight: bold;
  padding: 2px 6px;
  border-radius: 50%;
  display: none; /* default hidden kalau qty = 0 */
}

  </style>
</head>
<body>
  <!-- ===================== HEADER ===================== -->
  <header>
    <div class="container header-inner">
      <img id="restoLogo" alt="Logo" />
      <div>
        <h1 id="restoName">Nama Restoran</h1>
        <div class="contact-info">
          <div id="alamatRestoranDisplay"></div>
          <div id="teleponRestoranDisplay"></div>
        </div>
      </div>
      <button class="dark-toggle" onclick="toggleDark()" title="Toggle theme">🌙</button>
    </div>
  </header>

  <!-- ===================== TABS ===================== -->
  <div class="tabs-wrap">
    <div class="container">
      <div class="tabs">
        <div class="tab active" onclick="switchTab('food')">Food</div>
        <div class="tab" onclick="switchTab('snack')">Snack & Dessert</div>
        <div class="tab" onclick="switchTab('drink')">Drink</div>
        <div class="tab" onclick="switchTab('special')">Special</div>
        <div class="tab" onclick="switchTab('promo')">Promo</div>
      </div>
    </div>
  </div>

  <!-- ===================== CONTENT ===================== -->
  <main class="container">
    <section id="food" class="tab-content active"><div class="grid" id="foodGrid"></div></section>
    <section id="snack" class="tab-content"><div class="grid" id="snackGrid"></div></section>
    <section id="drink" class="tab-content"><div class="grid" id="drinkGrid"></div></section>
    <section id="special" class="tab-content"><div class="grid" id="specialGrid"></div></section>
    <section id="promo" class="tab-content"><div class="grid" id="promoGrid"></div></section>
  </main>

  <!-- ===================== FOOTER / CART + FORM ===================== -->
  <footer>
    <div class="container footer-inner">
      <div class="cart" id="cartBox">
        <h3>🛒 Your Cart</h3>
        <div id="cartRows" class="cart-rows"></div>
        <div id="cartEmpty" class="cart-empty">No items choice</div>
        <div class="cart-total">
          <div>Total</div>
          <div id="cartTotal">Rp 0</div>
        </div>

        <div class="form">
          <div>
            <label for="custName">Customer Name</label>
            <input type="text" id="custName" placeholder="e.g. John Doe" />
          </div>
          <div>
            <label for="custTable">Table No</label>
            <input type="text" id="custTable" placeholder="e.g. A12" />
          </div>
          <div>
            <label for="custDate">Date</label>
            <input type="text" id="custDate" readonly />
          </div>
          <div>
            <label for="custTime">Time</label>
            <input type="text" id="custTime" readonly />
          </div>
          <div style="grid-column: 1/-1;">
            <label for="custNote">Special Request / Notes</label>
            <textarea id="custNote" placeholder="e.g. no spicy, extra sauce"></textarea>
          </div>
        </div>
        <div class="actions">
          <button class="btn btn-wa" onclick="sendOrder()">📤 Submit Order</button>
          <button class="btn btn-back" onclick="history.back()">🔙 Back</button>
        </div>
      </div>
    </div>
  </footer>

  <script>
    // ===================== STATE =====================
    let menuData = [];
    let menuPromo = [];
    let restoData = {};

    // Cart items: { key, nama, harga (number), qty (number) }
    let cart = [];

    // ===================== UTILS =====================
    const fmtIDR = n => `Rp ${Number(n || 0).toLocaleString('id-ID')}`;

    function switchTab(id) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector(`.tab[onclick="switchTab('${id}')"]`).classList.add('active');
      document.getElementById(id).classList.add('active');
    }

    // ===================== DARK MODE =====================
    function applyTheme() {
      const saved = localStorage.getItem('menuva_theme');
      if (saved === 'dark') document.body.classList.add('dark');
      document.querySelector('.dark-toggle').textContent = document.body.classList.contains('dark') ? '☀️' : '🌙';
    }
    function toggleDark() {
      document.body.classList.toggle('dark');
      localStorage.setItem('menuva_theme', document.body.classList.contains('dark') ? 'dark' : 'light');
      document.querySelector('.dark-toggle').textContent = document.body.classList.contains('dark') ? '☀️' : '🌙';
    }

    // ===================== CART =====================
    function addToCart(name, price) {
      // Normalize price to number
      const harga = typeof price === 'string' ? parseFloat(String(price).replace(/[^0-9.]/g, '')) : Number(price);
      const key = name; // simple key by name; change if you have id
      const idx = cart.findIndex(i => i.key === key);
      if (idx >= 0) cart[idx].qty += 1; else cart.push({ key, nama: name, harga, qty: 1 });
      renderCart();
    }
    function updateQty(index, delta) {
      if (!cart[index]) return;
      cart[index].qty += delta;
      if (cart[index].qty <= 0) cart.splice(index, 1);
      renderCart();
    }
    function removeFromCart(index) {
      cart.splice(index, 1);
      renderCart();
    }
    function renderCart() {
      const rows = document.getElementById('cartRows');
      const empty = document.getElementById('cartEmpty');
      rows.innerHTML = '';
      if (cart.length === 0) {
        empty.style.display = 'block';
        document.getElementById('cartTotal').textContent = fmtIDR(0);
        return;
      }
      empty.style.display = 'none';
      let total = 0;
      cart.forEach((c, i) => {
        const subtotal = c.harga * c.qty;
        total += subtotal;
        const row = document.createElement('div');
        row.className = 'cart-row';
        row.innerHTML = `
          <div><strong>${c.nama}</strong><div style="font-size:12px;color:var(--muted)">${fmtIDR(c.harga)} × ${c.qty}</div></div>
          <div class="qty-wrap">
            <button onclick="updateQty(${i}, -1)">-</button>
            <input type="text" value="${c.qty}" readonly />
            <button onclick="updateQty(${i}, 1)">+</button>
          </div>
          <div class="price-right">${fmtIDR(subtotal)}</div>
          <button class="remove-btn" title="Remove" onclick="removeFromCart(${i})">✕</button>
        `;
        rows.appendChild(row);
      });
      document.getElementById('cartTotal').textContent = fmtIDR(total);
    }

    // ===================== RENDER MENU =====================
    function renderMenu() {
  const map = { food: 'foodGrid', snack: 'snackGrid', drink: 'drinkGrid', special: 'specialGrid' };
  Object.keys(map).forEach(k => {
    const grid = document.getElementById(map[k]);
    grid.innerHTML = '';
    const items = (menuData || []).filter(m => m.kategori === k);
    if (!items || items.length === 0) {
      grid.innerHTML = '<div class="cart-empty">No item yet</div>';
      return;
    }
    items.forEach(m => {
      const card = document.createElement('div');
      card.className = 'menu-card';
      // ✅ panggil tambahPesanan biar counter muncul
      card.onclick = () => tambahPesanan(m, card);
      card.innerHTML = `
        ${m.image ? `<img class="menu-thumb" src="${m.image}" alt="${m.nama}">` : `<div class="menu-thumb"></div>`}
        <div class="menu-title">${m.nama}</div>
        <div class="menu-desc">${m.deskripsi || ''}</div>
        <div class="menu-price">${fmtIDR(m.harga)}</div>
        <span class="order-count">0</span>
      `;
      grid.appendChild(card);
    });
  });
}


    function tambahPesanan(item, cardEl) {
  // update cart
  const existing = cart.find(c => c.nama === item.nama);
  if (existing) {
    existing.qty += 1;
  } else {
    cart.push({ ...item, qty: 1 });
  }

  // update tampilan counter di card
  const counter = cardEl.querySelector(".order-count");
  if (counter) {
    const cartItem = cart.find(c => c.nama === item.nama);
    counter.textContent = cartItem.qty;
    counter.style.display = "inline-block"; // kalau awalnya hidden
  }

  renderCart(); // supaya preview cart ikut update
}


    // ===================== RENDER PROMO + COUNTDOWN =====================
    // ===================== RENDER PROMO + COUNTDOWN (safe DOM build) =====================
let promoCountdownTimer = null;

function renderPromo() {
  const grid = document.getElementById('promoGrid');
  grid.innerHTML = '';
  const now = Date.now();
  const promos = (menuPromo || []).filter(p => {
    if (!p.tanggalAkhir) return true;
    const end = new Date(p.tanggalAkhir).getTime();
    return isFinite(end) ? end > now : true;
  });

  if (!promos || promos.length === 0) {
    grid.innerHTML = '<div class="cart-empty">No promo choice</div>';
    stopPromoCountdown();
    return;
  }

  promos.forEach(p => {
    // create card
    const card = document.createElement('div');
    card.className = 'menu-card promo-card';

    // prepare canonical item object (so tambahPesanan sees same fields as normal menu)
    const item = {
      nama: p.namaMenu || p.namaPromo || 'Promo Item',
      harga: Number(p.harga) || 0,
      deskripsi: p.deskripsi || '',
      image: p.image || ''
    };

    // click -> add to cart via tambahPesanan
    card.addEventListener('click', (ev) => {
      // prevent double clicks if expired (optional)
      if (p.tanggalAkhir) {
        const end = new Date(p.tanggalAkhir).getTime();
        if (isFinite(end) && Date.now() > end) return;
      }
      tambahPesanan(item, card);
    });

    // PROMO badge
    const badge = document.createElement('span');
    badge.className = 'promo-badge';
    badge.textContent = 'PROMO';
    card.appendChild(badge);

    // image or placeholder
    if (p.image) {
      const img = document.createElement('img');
      img.className = 'menu-thumb';
      img.src = p.image;
      img.alt = p.namaPromo || item.nama;
      card.appendChild(img);
    } else {
      const ph = document.createElement('div');
      ph.className = 'menu-thumb';
      card.appendChild(ph);
    }

    // title
    const title = document.createElement('div');
    title.className = 'menu-title';
    title.textContent = p.namaPromo || p.namaMenu || '';
    card.appendChild(title);

    // desc
    const desc = document.createElement('div');
    desc.className = 'menu-desc';
    desc.textContent = p.deskripsi || '';
    card.appendChild(desc);

    // price
    const price = document.createElement('div');
    price.className = 'menu-price';
    price.textContent = fmtIDR(p.harga);
    card.appendChild(price);

    // countdown element (if any)
    if (p.tanggalAkhir) {
      const c = document.createElement('div');
      c.className = 'promo-count';
      c.dataset.end = p.tanggalAkhir;
      card.appendChild(c);
    }

    // order count (hidden by default)
    const counter = document.createElement('span');
    counter.className = 'order-count';
    counter.textContent = '0';
    counter.style.display = 'none';
    card.appendChild(counter);

    // append to grid
    grid.appendChild(card);
  });

  startPromoCountdown();
}

function startPromoCountdown() {
  stopPromoCountdown();
  const tick = () => {
    const nodes = document.querySelectorAll('.promo-count[data-end]');
    const now = Date.now();
    nodes.forEach(el => {
      const end = new Date(el.dataset.end).getTime();
      if (!isFinite(end)) { el.textContent = ''; return; }
      const diff = end - now;
      if (diff <= 0) { el.textContent = 'Expired'; return; }
      const d = Math.floor(diff / 86400000);
      const h = Math.floor((diff % 86400000) / 3600000);
      const m = Math.floor((diff % 3600000) / 60000);
      const s = Math.floor((diff % 60000) / 1000);
      el.textContent = `Ends in ${d}d ${h}h ${m}m ${s}s`;
    });
  };
  tick();
  promoCountdownTimer = setInterval(tick, 1000);
}

function stopPromoCountdown() {
  if (promoCountdownTimer) {
    clearInterval(promoCountdownTimer);
    promoCountdownTimer = null;
  }
}

    // ===================== SEND ORDER (WhatsApp) =====================
    function sendOrder() {
      if (!restoData.nomorWaAdmin || restoData.nomorWaAdmin.length === 0) {
        alert('WhatsApp admin not set');
        return;
      }
      const name = document.getElementById('custName').value.trim();
      const table = document.getElementById('custTable').value.trim();
      if (!name || !table) { alert('Please fill customer name and table number!'); return; }
      if (cart.length === 0) { alert('Cart is empty!'); return; }

      const adminNo = String(restoData.nomorWaAdmin[0]).replace(/[^0-9]/g, '');
      const date = document.getElementById('custDate').value;
      const time = document.getElementById('custTime').value;
      const note = document.getElementById('custNote').value.trim();

      let msg = `🍽️ New Dine-in Order - ${restoData.namaRestoran || ''}

`;
      msg += `Name: ${name}
`;
      msg += `Table: ${table}
`;
      msg += `Date: ${date}
`;
      msg += `Time: ${time}

`;
      msg += `📝 Order:
`;
      let total = 0;
      cart.forEach((c, i) => {
  const line = `${i + 1}. ${c.nama}  x${c.qty}  -  ${fmtIDR(c.harga * c.qty)}`;
  total += c.harga * c.qty;
  msg += line + "\n";   // ✅ FIXED
});
      msg += `
Total: ${fmtIDR(total)}`;
      if (note) msg += `

Notes: ${note}`;

      const url = `https://wa.me/${adminNo}?text=${encodeURIComponent(msg)}`;
      window.open(url, '_blank');
    }

    // ===================== IndexedDB (load) =====================
    const DB_NAME = 'MenuvaDB';
    const STORE_NAME = 'menuvaData';
    const DB_VERSION = 1;
    let db;

    function initDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = (e) => {
          db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME);
        };
        req.onerror = () => reject(req.error);
        req.onsuccess = (e) => { db = e.target.result; resolve(); };
      });
    }
    function loadDataFromDB() {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readonly');
        const store = tx.objectStore(STORE_NAME);
        const req = store.get(1);
        req.onsuccess = () => resolve(req.result || {});
        req.onerror = () => reject(req.error);
      });
    }

    // ===================== INIT =====================
    window.addEventListener('DOMContentLoaded', async () => {
      applyTheme();

      await initDB();
      const data = await loadDataFromDB();
      restoData = data || {};
      menuData = data.menu || [];
      menuPromo = data.menuPromo || [];

      // Header
      document.getElementById('restoLogo').src = data.logo || '';
      document.getElementById('restoName').innerText = data.namaRestoran || 'Nama Restoran';
      document.getElementById('alamatRestoranDisplay').innerText = data.restoAddress || '';
      document.getElementById('teleponRestoranDisplay').innerText = data.restoPhone || '';

      // Date & Time (auto)
      const now = new Date();
      const pad = n => String(n).padStart(2, '0');
      const dateStr = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}`;
      const timeStr = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
      document.getElementById('custDate').value = dateStr;
      document.getElementById('custTime').value = timeStr;

      // Render content
      renderMenu();
      renderPromo();
      renderCart();
    });
  </script>
</body>
</html>
